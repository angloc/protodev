# docker-compose.yml for development environment
# Used for standalone Docker Compose workflow (alternative to VS Code DevContainer)
#
# Requirements:
# - make utility
# - Docker Compose (via Docker Desktop, Podman, or Rancher Desktop)
# - Windows: WSL (Windows Subsystem for Linux)

services:
  dev:
    image: ghcr.io/angloc/protodev:latest
    container_name: protodev

    # Mount the project directory
    volumes:
      # Project files
      - ..:/workspace

      # Git authentication: Docker Compose doesn't have automatic credential forwarding.
      # For SSH authentication, you can manually mount your SSH keys:
      # - ${HOME}/.ssh:/home/vscode/.ssh:ro          # Linux/Mac
      # - ${USERPROFILE}/.ssh:/home/vscode/.ssh:ro   # Windows

      # Docker-in-Docker volume
      - docker-dind-data:/var/lib/docker

    # Port mappings
    ports:
      - "8080:8080"   # Application server
      - "14500:14500" # Xpra HTML5 web interface
      - "8888:8888"   # JupyterLab

    # Working directory
    working_dir: /workspace

    # Docker-in-Docker requires privileged mode
    privileged: true
    init: true
    # Increase shared memory to prevent Chrome crashes
    shm_size: '2gb'
    security_opt:
      - seccomp:unconfined

    # Run postCreateCommand.sh on startup, then start services
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Run the postCreateCommand script if it exists
        if [ -f ./.devcontainer/postCreateCommand.sh ]; then
          echo "Running postCreateCommand.sh..."
          chmod +x ./.devcontainer/postCreateCommand.sh 2>/dev/null || true
          bash ./.devcontainer/postCreateCommand.sh
        fi

        # Start Xpra HTML5 server for GUI apps
        echo "Starting Xpra HTML5 server..."
        mkdir -p /home/vscode/.xpra
        xpra start :100 --bind-tcp=0.0.0.0:14500 --html=on --daemon=no \
            --keyboard-layout=us \
            --log-file=/home/vscode/.xpra/xpra.log &

        # Keep container running
        echo "Container ready!"
        tail -f /dev/null

    # Environment variables
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - DISPLAY=:100

    # Ensure proper permissions for Docker socket
    user: vscode
    group_add:
      - docker

  jupyter:
    image: ghcr.io/angloc/protodev:latest
    container_name: protodev-jupyter

    # Mount the project directory
    volumes:
      # Project files
      - ..:/workspace

      # Git authentication: Docker Compose doesn't have automatic credential forwarding.
      # For SSH authentication, you can manually mount your SSH keys:
      # - ${HOME}/.ssh:/home/vscode/.ssh:ro          # Linux/Mac
      # - ${USERPROFILE}/.ssh:/home/vscode/.ssh:ro   # Windows

    ports:
      - "8889:8888"

    working_dir: /workspace
    privileged: true
    security_opt:
      - seccomp:unconfined

    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        if [ -f ./.devcontainer/postCreateCommand.sh ]; then
          echo "Running postCreateCommand.sh..."
          chmod +x ./.devcontainer/postCreateCommand.sh 2>/dev/null || true
          bash ./.devcontainer/postCreateCommand.sh
        fi

        echo "Starting JupyterLab..."
        mkdir -p /workspace/projects
        jupyter lab --notebook-dir=/workspace/projects --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password=''

    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1

    user: vscode
    group_add:
      - docker

    depends_on:
      - dev

# Docker-in-Docker volume
volumes:
  docker-dind-data:
