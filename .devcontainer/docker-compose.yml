# docker-compose.yml for development environment
# Replicates the .devcontainer configuration for standalone use
#
# IMPORTANT: This file mirrors .devcontainer/devcontainer.json
# Any changes to mounts, ports, or configuration should be synchronized between:
# - This docker-compose.yml
# - .devcontainer/devcontainer.json
# - .devcontainer/Dockerfile
# - .devcontainer/postCreateCommand.sh

services:
  dev:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: protodev

    # Mount the project directory
    volumes:
      # Project files
      - ..:/workspace

      # Git authentication: Docker Compose doesn't have automatic credential forwarding.
      # For SSH authentication, you can manually mount your SSH keys:
      # - ${HOME}/.ssh:/home/vscode/.ssh:ro          # Linux/Mac
      # - ${USERPROFILE}/.ssh:/home/vscode/.ssh:ro   # Windows

      # Docker-in-Docker volume
      - docker-dind-data:/var/lib/docker

    # Port mappings
    ports:
      - "8080:8080"   # Application server
      - "14500:14500" # Xpra HTML5 web interface
      - "8888:8888"   # JupyterLab

    # Working directory
    working_dir: /workspace

    # Docker-in-Docker requires privileged mode
    privileged: true
    init: true
    # Increase shared memory to prevent Chrome crashes
    shm_size: '2gb'
    security_opt:
      - seccomp:unconfined

    # Run postCreateCommand.sh on startup, then start services
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Run the postCreateCommand script if it exists
        if [ -f ./.devcontainer/postCreateCommand.sh ]; then
          echo "Running postCreateCommand.sh..."
          chmod +x ./.devcontainer/postCreateCommand.sh 2>/dev/null || true
          bash ./.devcontainer/postCreateCommand.sh
        fi

        # Start Xpra HTML5 server for GUI apps
        # --keyboard-layout=us ensures keyboard input works in the HTML5 client
        echo "Starting Xpra HTML5 server..."
        mkdir -p /home/vscode/.xpra
        xpra start :100 --bind-tcp=0.0.0.0:14500 --html=on --daemon=no \
            --keyboard-layout=uk \
            --log-file=/home/vscode/.xpra/xpra.log &

        # Start Docker daemon as the main process (foreground)
        echo "Starting Docker daemon as main process..."
        exec sudo dockerd

    # Environment variables
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - DISPLAY=:100

    # Ensure proper permissions for Docker socket
    user: vscode
    group_add:
      - docker

  jupyter:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: protodev-jupyter

    # Mount the project directory
    volumes:
      # Project files
      - ..:/workspace

      # Git authentication: Docker Compose doesn't have automatic credential forwarding.
      # For SSH authentication, you can manually mount your SSH keys:
      # - ${HOME}/.ssh:/home/vscode/.ssh:ro          # Linux/Mac
      # - ${USERPROFILE}/.ssh:/home/vscode/.ssh:ro   # Windows

    ports:
      - "8888:8888"

    working_dir: /workspace
    privileged: true
    security_opt:
      - seccomp:unconfined

    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        if [ -f ./.devcontainer/postCreateCommand.sh ]; then
          echo "Running postCreateCommand.sh..."
          chmod +x ./.devcontainer/postCreateCommand.sh 2>/dev/null || true
          bash ./.devcontainer/postCreateCommand.sh
        fi

        echo "Starting JupyterLab..."
        mkdir -p /workspace/projects
        jupyter lab --notebook-dir=/workspace/projects --ip=0.0.0.0 --port=8888 --no-browser --allow-root --NotebookApp.token='' --NotebookApp.password=''

    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1

    user: vscode
    group_add:
      - docker

    depends_on:
      - dev

# Docker-in-Docker volume
volumes:
  docker-dind-data:
